name: Daily Update

on:
  schedule:
    - cron: '55 0 */2 * *'  # 每2天凌晨00点55分执行任务（上海时区对应的UTC时间）
  workflow_dispatch:
    branches:
      - main

jobs:
  run_script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: pip install requests

    - name: Run main script
      run: python main.py  # 生成output目录下的live.m3u和live.txt

    - name: Download EPG File
      run: |
        wget -q http://epg.51zmt.top:8000/e.xml -O output/epg.xml
        wget -q https://epg.v1.mk/fy.xml -O output/fy.xml
      # 下载多个EPG文件并统一存放至output目录（按需扩展）

    - name: Configure Git user
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

    - name: Pull latest changes from remote
      run: git pull origin main --allow-unrelated-histories  # 拉取远程分支并允许无关历史

    - name: Add changed files
      run: git add output/live.m3u output/live.txt output/*.xml  # 添加生成的文件

    - name: Commit and push if changes exist
      run: |
        if [ -n "$(git diff --staged --exit-code)" ]; then
          git commit -m "Update: Live streams and EPG files"  # 提交变更
          git push origin main --ff-only  # 明确指定远程仓库和分支，确保快进式推送
        else
          echo "No changes to commit"  # 无变更时提示
        fi
    env:
      TZ: Asia/Shanghai  # 设置上海时区
      LANG: en_US.UTF-8  # 设置语言环境
